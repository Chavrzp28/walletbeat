---
// Constants
import {
	navigationAbout,
	navigationFaq,
	navigationRepository,
	navigationFarcasterChannel,
	navigationHome,
} from '@/constants/navigation'

import { newsRegistry } from '@/data/news'
import { IncidentStatus, NewsType, Severity } from '@/types/content/news'
import { refs } from '@/schema/reference'

// Layouts
import Layout from '@/layouts/Layout.astro'

// Components
import Navigation from '@/views/Navigation.astro'

import NewspaperIcon from 'lucide-static/icons/newspaper.svg?raw'
import ShieldAlertIcon from 'lucide-static/icons/shield-alert.svg?raw'
import ShieldCheckIcon from 'lucide-static/icons/shield-check.svg?raw'
import TriangleAlertIcon from 'lucide-static/icons/triangle-alert.svg?raw'
import InfoIcon from 'lucide-static/icons/info.svg?raw'

// Convert registry object to array and sort by date (newest first)
const allNews = Object.values(newsRegistry).sort((a, b) => {
	return b.publishedAt.localeCompare(a.publishedAt)
})

// Helper functions for rendering
function getSeverityColor(severity: Severity) {
	switch (severity) {
		case Severity.CRITICAL:
			return 'var(--color-critical)'
		case Severity.HIGH:
			return 'var(--color-high)'
		case Severity.MEDIUM:
			return 'var(--color-medium)'
		case Severity.LOW:
			return 'var(--color-low)'
	}
}

function getStatusIcon(status: IncidentStatus) {
	switch (status) {
		case IncidentStatus.RESOLVED:
			return ShieldCheckIcon
		case IncidentStatus.MITIGATED:
			return ShieldAlertIcon
		case IncidentStatus.ONGOING:
			return TriangleAlertIcon
		case IncidentStatus.DISPUTED:
			return InfoIcon
	}
}

function formatDate(dateString: string) {
	const date = new Date(dateString)
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	})
}

function getTypeLabel(type: NewsType) {
	switch (type) {
		case NewsType.HACK:
			return 'Hack'
		case NewsType.DATA_BREACH:
			return 'Data Breach'
		case NewsType.VULNERABILITY:
			return 'Vulnerability'
		case NewsType.INCIDENT:
			return 'Incident'
	}
}
---

<Layout
	metadata={{
		title: 'Wallet Security News',
		keywordsAfter: ['news', 'security', 'incidents'],
	}}
>
	<Navigation
		navigationItems={[
			navigationHome,
			navigationAbout,
			navigationFaq,
			{
				id: 'news',
				title: 'Security News',
				icon: NewspaperIcon,
				href: '/news/',
			},
			navigationRepository,
			navigationFarcasterChannel,
		]}
	/>

	<main data-sticky-container data-column='gap-8'>
		<header data-scroll-item='inline-detached padding-match-start'>
			<hgroup data-column='gap-4'>
				<h1>Wallet Security News</h1>
				<p>Security incidents, vulnerabilities, and data breaches affecting Ethereum wallets</p>
			</hgroup>
		</header>

		<hr />

		{allNews.length === 0 ? (
			<section data-scroll-item='inline-detached' data-column='gap-5'>
				<p>No security news items currently tracked.</p>
			</section>
		) : (
			allNews.map(news => (
				<>
					<section id={news.name} data-scroll-item='inline-detached' data-column='gap-4'>
						<header data-column='gap-2'>
							<div class='news-meta'>
								<span class='wallet-badge'>
									<img
										src={`/images/wallets/${news.wallet.id}.${news.wallet.iconExtension}`}
										alt={news.wallet.displayName}
									/>
									{news.wallet.displayName}
								</span>
								<span class='type-badge'>{getTypeLabel(news.type)}</span>
								<span
									class='severity-badge'
									style={`--severity-color: ${getSeverityColor(news.severity)}`}
								>
									{news.severity}
								</span>
								<span class='status-badge' data-status={news.status.toLowerCase()}>
									<span set:html={getStatusIcon(news.status)} />
									{news.status}
								</span>
							</div>
							<h2>{news.title}</h2>
							<time datetime={news.publishedAt}>
								Published {formatDate(news.publishedAt)}
								{news.publishedAt !== news.updatedAt && (
									<> • Updated {formatDate(news.updatedAt)}</>
								)}
							</time>
						</header>

						<p class='summary'>{news.summary}</p>

						<div class='impact-info'>
							<strong>Impact:</strong>
							<ul>
								<li>Funds: {news.impact.fundsImpacted ? 'Affected' : 'Not affected'}</li>
								<li>Category: {news.impact.category.replace(/_/g, ' ').toLowerCase()}</li>
							</ul>
						</div>

						{refs(news).length > 0 && (
							<div class='references'>
								<strong>Sources:</strong>
								<ul>
									{refs(news).map((ref) =>
										ref.urls.map((url) => (
											<li>
												<a
													href={url.url}
													target='_blank'
													rel='noopener noreferrer'
												>
													{url.label} →
												</a>
											</li>
										))
									)}
								</ul>
							</div>
						)}
					</section>

					<hr />
				</>
			))
		)}

		<section data-scroll-item='inline-detached padding-match-end' data-column='gap-5'>
			<p>
				Know about a security incident affecting a wallet? Please help by <a
					href='https://github.com/walletbeat/walletbeat'
					target='_blank'
					rel='noopener noreferrer'>contributing to our repository</a>!
			</p>
		</section>
	</main>
</Layout>

<style>
	main {
		&[data-sticky-container] {
			--scrollItem-inlineDetached-maxSize: 48rem;
			--scrollItem-inlineDetached-maxPaddingMatchStart: 5rem;
			--scrollItem-inlineDetached-maxPaddingMatchEnd: 5rem;
		}

		line-height: 1.4;

		hgroup p {
			font-size: 1.1rem;
			color: var(--text-secondary);
			opacity: 0.85;
		}

		section {
			line-height: 1.7;

			header {
				h2 {
					font-size: 1.5rem;
					margin: 0;
					line-height: 1.3;
				}

				time {
					font-size: 0.9rem;
					color: var(--text-secondary);
					font-style: italic;
				}
			}

			.summary {
				margin: 0;
			}

			.impact-info {
				background: var(--background-secondary, rgba(0, 0, 0, 0.1));
				padding: 1rem;
				border-radius: 0.5rem;
				font-size: 0.95rem;

				strong {
					display: block;
					margin-bottom: 0.5rem;
				}

				ul {
					margin: 0;
					padding-inline-start: 1.5em;
					line-height: 1.6;

					li {
						text-transform: capitalize;
					}
				}
			}

			.source-link {
				display: inline-block;
				margin-top: 0.5rem;
				font-weight: 500;
				text-decoration: none;
				color: var(--accent);

				&:hover {
					text-decoration: underline;
				}
			}
		}

		.news-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			align-items: center;
			margin-bottom: 0.5rem;
		}

		.wallet-badge,
		.type-badge,
		.severity-badge,
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
			padding: 0.25rem 0.625rem;
			border-radius: 0.375rem;
			font-size: 0.8rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.025em;
		}

		.wallet-badge {
			background: var(--background-secondary, rgba(0, 0, 0, 0.1));
			color: var(--text-primary);

			img {
				width: 1.25rem;
				height: 1.25rem;
				border-radius: 0.25rem;
			}
		}

		.type-badge {
			background: var(--background-tertiary, rgba(0, 0, 0, 0.15));
			color: var(--text-secondary);
		}

		.severity-badge {
			background: var(--severity-color, var(--text-secondary));
			color: white;
		}

		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;

			span {
				display: inline-flex;
				width: 1rem;
				height: 1rem;

				:global(svg) {
					width: 100%;
					height: 100%;
				}
			}

			&[data-status='resolved'] {
				background: #10b981;
				color: white;
			}

			&[data-status='mitigated'] {
				background: #f59e0b;
				color: white;
			}

			&[data-status='ongoing'] {
				background: #ef4444;
				color: white;
			}

			&[data-status='disputed'] {
				background: #6b7280;
				color: white;
			}
		}
	}
</style>