---
// Constants
import {
	navigationAbout,
	navigationFaq,
	navigationRepository,
	navigationFarcasterChannel,
	navigationHome,
defaultNavigationItems,
} from '@/constants/navigation'

import { newsRegistry } from '@/data/news'
import { IncidentStatus, NewsType, Severity } from '@/types/content/news'
import { refs } from '@/schema/reference'

// Layouts
import Layout from '@/layouts/Layout.astro'

// Components
import Navigation from '@/views/Navigation.astro'

import NewspaperIcon from 'lucide-static/icons/newspaper.svg?raw'
import ShieldAlertIcon from 'lucide-static/icons/shield-alert.svg?raw'
import ShieldCheckIcon from 'lucide-static/icons/shield-check.svg?raw'
import TriangleAlertIcon from 'lucide-static/icons/triangle-alert.svg?raw'
import InfoIcon from 'lucide-static/icons/info.svg?raw'

// Convert registry object to array and sort by date (newest first)
const allNews = Object.values(newsRegistry).sort((a, b) => {
	return b.publishedAt.localeCompare(a.publishedAt)
})

// Helper functions for rendering
function getSeverityColor(severity: Severity) {
	switch (severity) {
		case Severity.CRITICAL:
			return 'var(--color-critical)'
		case Severity.HIGH:
			return 'var(--color-high)'
		case Severity.MEDIUM:
			return 'var(--color-medium)'
		case Severity.LOW:
			return 'var(--color-low)'
	}
}

function getStatusIcon(status: IncidentStatus) {
	switch (status) {
		case IncidentStatus.RESOLVED:
			return ShieldCheckIcon
		case IncidentStatus.MITIGATED:
			return ShieldAlertIcon
		case IncidentStatus.ONGOING:
			return TriangleAlertIcon
		case IncidentStatus.DISPUTED:
			return InfoIcon
	}
}

function formatDate(dateString: string) {
	const date = new Date(dateString)
	return date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	})
}

function getTypeLabel(type: NewsType) {
	switch (type) {
		case NewsType.HACK:
			return 'Hack'
		case NewsType.DATA_BREACH:
			return 'Data Breach'
		case NewsType.VULNERABILITY:
			return 'Vulnerability'
		case NewsType.INCIDENT:
			return 'Incident'
	}
}
---

<Layout
	metadata={{
		title: 'Wallet Security News',
		keywordsAfter: ['news', 'security', 'incidents'],
	}}
>
	<Navigation navigationItems={defaultNavigationItems} />

	<main data-sticky-container data-column='gap-8'>
		<header data-scroll-item='inline-detached padding-match-start'>
			<hgroup data-column='gap-4'>
				<h1>Wallet Security News</h1>
				<p>Security incidents, vulnerabilities, and data breaches affecting Ethereum wallets</p>
			</hgroup>
		</header>

		<hr />

		{allNews.length === 0 ? (
			<section data-scroll-item='inline-detached' data-column='gap-5'>
				<p>No security news items currently tracked.</p>
			</section>
		) : (
			allNews.map((news, index) => (
				<>
					<section id={news.name} data-scroll-item='inline-detached' class='news-item'>
						<div class='wallet-info'>
							<img
								src={`/images/wallets/${news.wallet.id}.${news.wallet.iconExtension}`}
								alt={news.wallet.displayName}
							/>
							<span class='wallet-name'>{news.wallet.displayName}</span>
						</div>

						<button
							class='news-header'
							data-news-toggle={`news-${index}`}
							aria-expanded='false'
							aria-controls={`news-content-${index}`}
						>
							<h2>{news.title}</h2>
							<svg class='chevron' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'>
								<polyline points='6 9 12 15 18 9'></polyline>
							</svg>
						</button>

						<div class='news-content' id={`news-content-${index}`} data-collapsed='true'>
							<div class='news-content-inner'>
								<time datetime={news.publishedAt}>
									Published {formatDate(news.publishedAt)}
									{news.publishedAt !== news.updatedAt && (
										<> • Updated {formatDate(news.updatedAt)}</>
									)}
								</time>

								<p class='summary'>{news.summary}</p>

								<div class='metadata-section'>
									<div class='metadata-row'>
										<div class='metadata-item'>
											<span class='metadata-label'>Type</span>
											<span class='type-badge'>{getTypeLabel(news.type)}</span>
										</div>
										<div class='metadata-item'>
											<span class='metadata-label'>Severity</span>
											<span
												class='severity-badge'
												style={`--severity-color: ${getSeverityColor(news.severity)}`}
											>
												{news.severity}
											</span>
										</div>
										<div class='metadata-item'>
											<span class='metadata-label'>Status</span>
											<span class='status-badge' data-status={news.status.toLowerCase()}>
												<span set:html={getStatusIcon(news.status)} />
												{news.status}
											</span>
										</div>
									</div>
									<div class='impact-info'>
										<strong>Impact:</strong>
										<ul>
											<li>Funds: {news.impact.fundsImpacted ? 'Affected' : 'Not affected'}</li>
											<li>Category: {news.impact.category.replace(/_/g, ' ').toLowerCase()}</li>
										</ul>
									</div>
								</div>

								{refs(news).length > 0 && (
									<div class='references'>
										<strong>Sources:</strong>
										<ul>
											{refs(news).map((ref) =>
												ref.urls.map((url) => (
													<li>
														<a
															href={url.url}
															target='_blank'
															rel='noopener noreferrer'
														>
															{url.label} →
														</a>
													</li>
												))
											)}
										</ul>
									</div>
								)}
							</div>
						</div>
					</section>

					<hr />
				</>
			))
		)}

		<section data-scroll-item='inline-detached padding-match-end' data-column='gap-5'>
			<p>
				Know about a security incident affecting a wallet? Please help by <a
					href='https://github.com/walletbeat/walletbeat'
					target='_blank'
					rel='noopener noreferrer'>contributing to our repository</a>!
			</p>
		</section>
	</main>
</Layout>

<style>
	main {
		&[data-sticky-container] {
			--scrollItem-inlineDetached-maxSize: 48rem;
			--scrollItem-inlineDetached-maxPaddingMatchStart: 5rem;
			--scrollItem-inlineDetached-maxPaddingMatchEnd: 5rem;
		}

		line-height: 1.4;

		hgroup p {
			font-size: 1.1rem;
			color: var(--text-secondary);
			opacity: 0.85;
		}

		.news-item {
			display: flex;
			flex-direction: column;
			gap: 0.75rem;

			.wallet-info {
				display: flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.5rem 0.75rem;
				background: var(--background-secondary, rgba(0, 0, 0, 0.1));
				border-radius: 0.375rem;
				width: fit-content;

				img {
					width: 1.5rem;
					height: 1.5rem;
					border-radius: 0.25rem;
				}

				.wallet-name {
					font-size: 0.9rem;
					font-weight: 600;
					color: var(--text-primary);
				}
			}

			.news-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				gap: 1rem;
				width: 100%;
				background: transparent;
				border: none;
				padding: 0;
				cursor: pointer;
				text-align: left;
				transition: opacity 0.2s;

				&:hover {
					opacity: 0.8;
				}

				h2 {
					font-size: 1.5rem;
					margin: 0;
					line-height: 1.3;
					flex: 1;
					color: var(--text-primary);
				}

				.chevron {
					flex-shrink: 0;
					color: var(--text-secondary);
					transition: transform 0.3s ease;
				}

				&[aria-expanded='true'] .chevron {
					transform: rotate(180deg);
				}
			}

			.news-content {
				overflow: hidden;
				transition: max-height 0.3s ease, opacity 0.3s ease;

				&[data-collapsed='true'] {
					max-height: 0;
					opacity: 0;
				}

				&[data-collapsed='false'] {
					max-height: 5000px;
					opacity: 1;
				}
			}

			.news-content-inner {
				display: flex;
				flex-direction: column;
				gap: 1rem;
				padding-top: 0.5rem;
			}

			time {
				font-size: 0.9rem;
				color: var(--text-secondary);
				font-style: italic;
			}

			.summary {
				margin: 0;
				font-size: 1.05rem;
				line-height: 1.7;
			}

			.metadata-section {
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}

			.metadata-row {
				display: flex;
				flex-wrap: wrap;
				gap: 1.5rem;
			}

			.metadata-item {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;

				.metadata-label {
					font-size: 0.75rem;
					font-weight: 600;
					text-transform: uppercase;
					letter-spacing: 0.05em;
					color: var(--text-secondary);
					opacity: 0.8;
				}
			}

			.impact-info {
				background: var(--background-secondary, rgba(0, 0, 0, 0.1));
				padding: 1rem;
				border-radius: 0.5rem;
				font-size: 0.95rem;

				strong {
					display: block;
					margin-bottom: 0.5rem;
				}

				ul {
					margin: 0;
					padding-inline-start: 1.5em;
					line-height: 1.6;

					li {
						text-transform: capitalize;
					}
				}
			}

			.references {
				strong {
					display: block;
					margin-bottom: 0.5rem;
				}

				ul {
					margin: 0;
					padding-inline-start: 1.5em;

					a {
						color: var(--accent);
						text-decoration: none;

						&:hover {
							text-decoration: underline;
						}
					}
				}
			}
		}

		.type-badge,
		.severity-badge,
		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
			padding: 0.375rem 0.75rem;
			border-radius: 0.375rem;
			font-size: 0.85rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.025em;
			width: fit-content;
		}

		.type-badge {
			background: var(--background-tertiary, rgba(0, 0, 0, 0.15));
			color: var(--text-secondary);
		}

		.severity-badge {
			background: var(--severity-color, var(--text-secondary));
			color: white;
		}

		.status-badge {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;

			span {
				display: inline-flex;
				width: 1rem;
				height: 1rem;

				:global(svg) {
					width: 100%;
					height: 100%;
				}
			}

			&[data-status='resolved'] {
				background: #10b981;
				color: white;
			}

			&[data-status='mitigated'] {
				background: #f59e0b;
				color: white;
			}

			&[data-status='ongoing'] {
				background: #ef4444;
				color: white;
			}

			&[data-status='disputed'] {
				background: #6b7280;
				color: white;
			}
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const toggleButtons = document.querySelectorAll('[data-news-toggle]')

		toggleButtons.forEach((button) => {
			button.addEventListener('click', () => {
				const isExpanded = button.getAttribute('aria-expanded') === 'true'
				const contentId = button.getAttribute('aria-controls')
				const content = document.getElementById(contentId!)

				if (content) {
					button.setAttribute('aria-expanded', (!isExpanded).toString())
					content.setAttribute('data-collapsed', isExpanded.toString())
				}
			})
		})
	})
</script>